<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>HOA Admin Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body { background:#f4f6f9 }
.card { border-radius:12px }
.badge-pending { background:#ffc107;color:#000 }
.badge-approved { background:#198754 }
.badge-rejected { background:#dc3545 }
</style>
</head>

<body>

<nav class="navbar navbar-dark bg-dark mb-4">
  <div class="container">
    <span class="navbar-brand">ðŸ›  HOA Admin Dashboard</span>
    <button class="btn btn-outline-light btn-sm" onclick="Admin.logout()">Logout</button>
  </div>
</nav>

<div class="container">

<!-- SUMMARY -->
<div class="row mb-4">
  <div class="col-md-3"><div class="card p-3 text-center"><h6>Pending</h6><h2 id="pendingCount">0</h2></div></div>
  <div class="col-md-3"><div class="card p-3 text-center"><h6>Total</h6><h2 id="totalCount">0</h2></div></div>
  <div class="col-md-3"><div class="card p-3 text-center"><h6>Monthly</h6><h2 id="monthlyTotal">â‚±0</h2></div></div>
  <div class="col-md-3"><div class="card p-3 text-center"><h6>Admin</h6><strong id="adminName"></strong></div></div>
</div>

<!-- FILTER -->
<div class="card p-3 mb-4">
<div class="row g-2">
  <div class="col-md-3">
    <select id="filterMonth" class="form-select">
      <option value="">All Months</option>
      <option>January</option><option>February</option><option>March</option>
      <option>April</option><option>May</option><option>June</option>
      <option>July</option><option>August</option><option>September</option>
      <option>October</option><option>November</option><option>December</option>
    </select>
  </div>
  <div class="col-md-2">
    <select id="filterYear" class="form-select">
      <option value="">All Years</option>
      <option>2025</option><option>2026</option><option>2027</option>
    </select>
  </div>
  <div class="col-md-2">
    <button class="btn btn-primary w-100" onclick="Admin.applyFilter()">Apply</button>
  </div>
</div>
</div>

<!-- PAYMENTS -->
<div class="card p-3">
<h5>Payment Approvals</h5>
<table class="table table-striped align-middle">
<thead>
<tr>
<th>ID</th><th>User</th><th>Month</th><th>Year</th>
<th>Status</th><th>Receipt</th><th>Action</th>
</tr>
</thead>
<tbody id="paymentsTable"></tbody>
</table>
</div>

</div>

<!-- REJECT MODAL -->
<div class="modal fade" id="rejectModal" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header"><h5>Reject Payment</h5></div>
<div class="modal-body">
<textarea id="rejectReason" class="form-control" placeholder="Reason"></textarea>
<input type="hidden" id="rejectPaymentId">
</div>
<div class="modal-footer">
<button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
<button class="btn btn-danger" onclick="Admin.confirmReject()">Reject</button>
</div>
</div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
const Admin = {
  month: "",
  year: "",
  rejectModal: null,

  init() {
    const username = localStorage.getItem("username");
    const role = localStorage.getItem("role");
    if (!username || role !== "admin") location.href="/login";
    adminName.innerText = username;

    this.rejectModal = new bootstrap.Modal(
      document.getElementById("rejectModal")
    );

    this.loadPayments();
  },

  applyFilter() {
    this.month = filterMonth.value;
    this.year = filterYear.value;
    this.loadPayments();
    this.loadMonthly();
  },

  async loadPayments() {
    const res = await fetch(`/api/admin/payments`);
    const data = await res.json();

    totalCount.innerText = data.length;
    pendingCount.innerText = data.filter(p => p[2] === "PENDING").length;

    paymentsTable.innerHTML = data.map(p => `
<tr>
<td>${p[0]}</td>
<td>${p[1]}</td>
<td>${p[4]}</td>
<td>${p[5]}</td>
<td>
<span class="badge ${
p[2]==="PENDING"?"badge-pending":
p[2]==="APPROVED"?"badge-approved":"badge-rejected"}">
${p[2]}
</span>
</td>
<td><a href="/uploads/${p[3]}" target="_blank">View</a></td>
<td>
${p[2]==="PENDING"?
`<button class="btn btn-sm btn-success me-1" onclick="Admin.approve(${p[0]})">Approve</button>
<button class="btn btn-sm btn-danger" onclick="Admin.openReject(${p[0]})">Reject</button>`
:"â€”"}
</td>
</tr>`).join("");
  },

  async approve(id) {
    await fetch(`/api/admin/payments/${id}/approve`, { method:"POST" });
    this.loadPayments(); this.loadMonthly();
  },

  openReject(id) {
    rejectPaymentId.value = id;
    rejectReason.value = "";
    this.rejectModal.show();
  },

  async confirmReject() {
    await fetch(`/api/admin/payments/${rejectPaymentId.value}/reject`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({ reason: rejectReason.value })
    });
    this.rejectModal.hide();
    this.loadPayments(); this.loadMonthly();
  },

  async loadMonthly() {
    if (!this.month || !this.year) {
      monthlyTotal.innerText="â‚±0"; return;
    }
    const res = await fetch(
      `/api/admin/reports/monthly?month=${this.month}&year=${this.year}`
    );
    const d = await res.json();
    monthlyTotal.innerText="â‚±"+(d.total||0);
  },

  logout() {
    localStorage.clear();
    location.href="/login";
  }
};

Admin.init();
</script>

</body>
</html>
