<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>HOA Admin Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body { background:#f4f6f9 }
.card { border-radius:12px }
.badge-pending { background:#ffc107;color:#000 }
.badge-approved { background:#198754 }
.badge-rejected { background:#dc3545 }
</style>
</head>

<body>

<nav class="navbar navbar-dark bg-dark mb-4">
  <div class="container">
    <span class="navbar-brand">ðŸ›  HOA Admin Dashboard</span>
    <button class="btn btn-outline-light btn-sm" onclick="logout()">Logout</button>
  </div>
</nav>

<div class="container">

<!-- SUMMARY -->
<div class="row mb-4">
  <div class="col-md-3"><div class="card p-3 text-center"><h6>Pending</h6><h2 id="pendingCount">0</h2></div></div>
  <div class="col-md-3"><div class="card p-3 text-center"><h6>Total</h6><h2 id="totalCount">0</h2></div></div>
  <div class="col-md-3"><div class="card p-3 text-center"><h6>Monthly Collection</h6><h2 id="monthlyTotal">â‚±0</h2></div></div>
  <div class="col-md-3"><div class="card p-3 text-center"><h6>Admin</h6><strong id="adminName"></strong></div></div>
</div>

<!-- FILTER / ACTIONS -->
<div class="card p-3 mb-4">
<div class="row g-2">
  <div class="col-md-3">
    <select id="filterMonth" class="form-select">
      <option value="">All Months</option>
      <option value="1">January</option><option value="2">February</option>
      <option value="3">March</option><option value="4">April</option>
      <option value="5">May</option><option value="6">June</option>
      <option value="7">July</option><option value="8">August</option>
      <option value="9">September</option><option value="10">October</option>
      <option value="11">November</option><option value="12">December</option>
    </select>
  </div>

  <div class="col-md-2">
    <select id="filterYear" class="form-select">
      <option value="">All Years</option>
      <option>2025</option><option>2026</option><option>2027</option>
    </select>
  </div>

  <div class="col-md-2">
    <button class="btn btn-primary w-100" onclick="applyFilter()">Apply</button>
  </div>

  <div class="col-md-2">
    <button class="btn btn-warning w-100" onclick="openCash()">Add Cash</button>
  </div>

  <div class="col-md-3 text-end">
    <button class="btn btn-outline-success me-2" onclick="exportExcel()">Excel</button>
    <button class="btn btn-outline-danger" onclick="exportPDF()">PDF</button>
  </div>
</div>
</div>

<!-- PAYMENTS -->
<div class="card p-3">
<h5>Payment Approvals</h5>
<div class="table-responsive">
<table class="table table-striped align-middle">
<thead>
<tr>
<th>ID</th><th>User</th><th>Month</th><th>Year</th>
<th>Status</th><th>Receipt</th><th>Action</th>
</tr>
</thead>
<tbody id="paymentsTable"></tbody>
</table>
</div>
</div>

</div>

<!-- REJECT MODAL -->
<div class="modal fade" id="rejectModal">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header"><h5>Reject Payment</h5></div>
<div class="modal-body">
<textarea id="rejectReason" class="form-control" placeholder="Reason"></textarea>
<input type="hidden" id="rejectPaymentId">
</div>
<div class="modal-footer">
<button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
<button class="btn btn-danger" onclick="confirmReject()">Reject</button>
</div>
</div>
</div>
</div>

<!-- CASH MODAL -->
<div class="modal fade" id="cashModal">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header"><h5>Manual Cash Payment</h5></div>
<div class="modal-body">
<input id="cashUser" class="form-control mb-2" placeholder="Username">
<input id="cashAmount" class="form-control" placeholder="Amount">
</div>
<div class="modal-footer">
<button class="btn btn-success" onclick="saveCash()">Save</button>
</div>
</div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
const username = localStorage.getItem("username");
const role = localStorage.getItem("role");
if (!username || role !== "admin") location.href="/login";
adminName.innerText = username;

let month="", year="";

/* FILTER */
function applyFilter(){
  month=filterMonth.value;
  year=filterYear.value;
  loadPayments();
  loadMonthly();
}

/* PAYMENTS */
async function loadPayments(){
  const res = await fetch(`/api/admin/payments?month=${month}&year=${year}`);
  const data = await res.json();

  totalCount.innerText=data.length;
  pendingCount.innerText=data.filter(p=>p.status==="PENDING").length;

  paymentsTable.innerHTML=data.map(p=>`
<tr>
<td>${p.id}</td><td>${p.username}</td><td>${p.month}</td><td>${p.year}</td>
<td><span class="badge ${
p.status==="PENDING"?"badge-pending":
p.status==="APPROVED"?"badge-approved":"badge-rejected"}">${p.status}</span></td>
<td><a href="/uploads/${p.receipt}" target="_blank">View</a></td>
<td>${p.status==="PENDING"?
`<button class="btn btn-sm btn-success me-1" onclick="approve(${p.id})">Approve</button>
<button class="btn btn-sm btn-danger" onclick="openReject(${p.id})">Reject</button>`:"â€”"}</td>
</tr>`).join("");
}

/* APPROVE */
async function approve(id){
  await fetch(`/api/admin/payments/${id}/approve`,{method:"POST"});
  loadPayments(); loadMonthly();
}

/* REJECT */
function openReject(id){
  rejectPaymentId.value=id;
  new bootstrap.Modal(rejectModal).show();
}
async function confirmReject(){
  await fetch(`/api/admin/payments/${rejectPaymentId.value}/reject`,{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({reason:rejectReason.value})
  });
  loadPayments(); loadMonthly();
}

/* MONTHLY REPORT */
async function loadMonthly(){
  if(!month||!year){monthlyTotal.innerText="â‚±0";return;}
  const res=await fetch(`/api/admin/reports/monthly?month=${month}&year=${year}`);
  const d=await res.json();
  monthlyTotal.innerText="â‚±"+d.total;
}

/* CASH */
function openCash(){ new bootstrap.Modal(cashModal).show(); }
async function saveCash(){
  await fetch(`/api/admin/payments/cash`,{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({user:cashUser.value,amount:cashAmount.value})
  });
  loadPayments(); loadMonthly();
}

/* EXPORT */
function exportExcel(){ window.open("/api/admin/export/excel"); }
function exportPDF(){ window.open("/api/admin/export/pdf"); }

function logout(){ localStorage.clear(); location.href="/login"; }

loadPayments();
</script>

</body>
</html>
