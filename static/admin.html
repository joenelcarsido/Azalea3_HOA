<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>HOA Admin Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body { background:#f4f6f9 }
.card { border-radius:12px }
.badge-pending { background:#ffc107;color:#000 }
.badge-approved { background:#198754 }
.badge-rejected { background:#dc3545 }
</style>
</head>

<body>

<nav class="navbar navbar-dark bg-dark mb-4">
  <div class="container">
    <span class="navbar-brand">ðŸ›  HOA Admin Dashboard</span>
    <button class="btn btn-outline-light btn-sm" onclick="logout()">Logout</button>
  </div>
</nav>

<div class="container">

<!-- SUMMARY -->
<div class="row mb-4">
  <div class="col-md-3">
    <div class="card p-3 text-center">
      <h6>Pending</h6>
      <h2 id="pendingCount">0</h2>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card p-3 text-center">
      <h6>Total</h6>
      <h2 id="totalCount">0</h2>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card p-3 text-center">
      <h6>Monthly Collection</h6>
      <h2 id="monthlyTotal">â‚±0</h2>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card p-3 text-center">
      <h6>Admin</h6>
      <strong id="adminName"></strong>
    </div>
  </div>
</div>

<!-- FILTER -->
<div class="card p-3 mb-4">
  <div class="row g-2">
    <div class="col-md-3">
      <select id="filterMonth" class="form-select">
        <option value="">All Months</option>
        <option>January</option><option>February</option>
        <option>March</option><option>April</option>
        <option>May</option><option>June</option>
        <option>July</option><option>August</option>
        <option>September</option><option>October</option>
        <option>November</option><option>December</option>
      </select>
    </div>

    <div class="col-md-2">
      <select id="filterYear" class="form-select">
        <option value="">All Years</option>
        <option>2025</option>
        <option>2026</option>
        <option>2027</option>
      </select>
    </div>

    <div class="col-md-2">
      <button class="btn btn-primary w-100" onclick="applyFilter()">Apply</button>
    </div>
  </div>
</div>

<!-- PAYMENTS -->
<div class="card p-3">
<h5>Payment Approvals</h5>

<div class="table-responsive">
<table class="table table-striped align-middle">
<thead>
<tr>
  <th>ID</th>
  <th>User</th>
  <th>Month</th>
  <th>Year</th>
  <th>Status</th>
  <th>Amount</th>
  <th>Receipt</th>
  <th>Action</th>
</tr>
</thead>
<tbody id="paymentsTable">
<tr><td colspan="8" class="text-center">Loading...</td></tr>
</tbody>
</table>
</div>
</div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* ---------- AUTH ---------- */
const username = localStorage.getItem("username");
const role = localStorage.getItem("role");

if (!username || role !== "admin") location.href="/login";
adminName.innerText = username;

let month = "", year = "";

/* ---------- FILTER ---------- */
function applyFilter(){
  month = filterMonth.value;
  year = filterYear.value;
  loadPayments();
  loadMonthly();
}

/* ---------- PAYMENTS ---------- */
async function loadPayments() {
  try {
    const res = await fetch(
      `/api/admin/payments?username=${username}&month=${month || ""}&year=${year || ""}`
    );

    if (!res.ok) {
      throw new Error("Failed to load payments");
    }

    const data = await res.json();

    totalCount.innerText = data.length;
    pendingCount.innerText = data.filter(p => (p.status ?? p[3]) === "PENDING").length;

    if (!data.length) {
      paymentsTable.innerHTML =
        `<tr><td colspan="8" class="text-center">No payments found</td></tr>`;
      return;
    }

    paymentsTable.innerHTML = data.map(p => {
      const id = p.id ?? p[0];
      const user = p.username ?? p[1];
      const receipt = p.filename ?? p[2];
      const status = p.status ?? p[3];
      const monthVal = p.month ?? p[5];
      const yearVal = p.year ?? p[6];
      const amount = p.amount ?? p[7] ?? "0.00";

      return `
      <tr>
        <td>${id}</td>
        <td>${user}</td>
        <td>${monthVal}</td>
        <td>${yearVal}</td>
        <td>
          <span class="badge ${
            status === "PENDING" ? "badge-pending" :
            status === "APPROVED" ? "badge-approved" : "badge-rejected"
          }">${status}</span>
        </td>
        <td>â‚±${amount}</td>
        <td><a href="/uploads/${receipt}" target="_blank">View</a></td>
        <td>
          ${status === "PENDING"
            ? `<button class="btn btn-sm btn-success me-1" onclick="approve(${id})">Approve</button>
               <button class="btn btn-sm btn-danger" onclick="reject(${id})">Reject</button>`
            : "â€”"}
        </td>
      </tr>`;
    }).join("");

  } catch (err) {
    paymentsTable.innerHTML =
      `<tr><td colspan="8" class="text-danger text-center">${err.message}</td></tr>`;
  }
}

/* ---------- REJECT ---------- */
async function reject(id){
  const reason = prompt("Reject reason:");
  if (!reason) return;

  await fetch(`/api/admin/payments/${id}/reject`, {
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ reason })
  });

  loadPayments();
  loadMonthly();
}

/* ---------- MONTHLY REPORT ---------- */
async function loadMonthly(){
  if(!month || !year){
    monthlyTotal.innerText = "â‚±0";
    return;
  }
  const res = await fetch(`/api/admin/reports/monthly?month=${month}&year=${year}`);
  const d = await res.json();
  monthlyTotal.innerText = "â‚±" + (d.total ?? 0);
}

/* ---------- LOGOUT ---------- */
function logout(){
  localStorage.clear();
  location.href="/login";
}

loadPayments();
</script>

</body>
</html>

