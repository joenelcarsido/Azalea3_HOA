<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>User Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<nav class="navbar navbar-dark bg-primary px-3">
  <span class="navbar-brand">HOA User Dashboard</span>
  <button class="btn btn-danger btn-sm" onclick="logout()">Logout</button>
</nav>

<div class="container mt-4">
  <h4>Upload Payment Receipt</h4>

  <input type="file" id="file" class="form-control mt-2">
  <button class="btn btn-success mt-2" onclick="upload()">Upload</button>

  <hr>

  <h5>Latest Payment Status</h5>
  <div id="status" class="mt-2 text-muted"></div>
</div>

<script>
const username = localStorage.getItem("username");
const role = localStorage.getItem("role");

// ðŸ”’ SECURITY CHECK
if (!username || role !== "homeowner") {
  alert("Unauthorized");
  window.location.href = "/login";
}

async function upload() {
  const fileInput = document.getElementById("file");
  if (!fileInput.files.length) {
    alert("Please select a file");
    return;
  }

  const formData = new FormData();
  formData.append("file", fileInput.files[0]);

  const res = await fetch(`/api/upload-receipt?username=${username}`, {
    method: "POST",
    body: formData
  });

  const data = await res.json();
  alert(data.message);
  loadStatus();
}

async function loadStatus() {
  const res = await fetch(`/api/payment-status/${username}`);
  const data = await res.json();

  document.getElementById("status").innerText =
    data.status === "NO PAYMENT"
      ? "No payment uploaded"
      : `Status: ${data.status} (Uploaded: ${data.uploaded_at})`;
}

function logout() {
  localStorage.clear();
  window.location.href = "/login";
}

loadStatus();
</script>

</body>
</html>
